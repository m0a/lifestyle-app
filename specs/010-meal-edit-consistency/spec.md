# Feature Specification: 食事編集画面の一貫性改善

**Feature Branch**: `010-meal-edit-consistency`
**Created**: 2026-01-02
**Status**: Draft
**Input**: User description: "食事の編集画面に一貫性がない - カロリーと内容の編集しかできず、AI支援も活かせない。登録時と同じように修正できてほしい。" (GitHub Issue #10)

## Clarifications

### Session 2026-01-02

- Q: 編集画面へのアクセス方法は？ → A: MealDetailページに「編集」ボタンを追加し、編集モードに切り替える

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 食品アイテムの編集 (Priority: P1)

ユーザーが過去に登録した食事の食品アイテム（ご飯、味噌汁など）を個別に編集・削除・追加したい。現在は登録時にのみ食品アイテムの操作が可能だが、編集時にも同じ操作ができるようにする。

**Why this priority**: 食事記録の正確性を保つための最も基本的な機能。登録後に間違いに気づいた場合や、食べ残した場合に修正できないと、カロリー管理の信頼性が損なわれる。

**Independent Test**: 既存の食事記録を開き、食品アイテムの編集・削除・追加ができることを確認。変更後に栄養素合計が自動再計算されることを検証。

**Acceptance Scenarios**:

1. **Given** AI分析済みの食事記録が存在する, **When** ユーザーが編集画面を開く, **Then** 食品アイテム一覧が表示され、各アイテムの編集・削除ボタンが利用可能
2. **Given** 食品アイテム一覧が表示されている, **When** ユーザーがアイテムの分量を変更する, **Then** そのアイテムの栄養素と全体の合計が自動的に再計算される
3. **Given** 食品アイテム一覧が表示されている, **When** ユーザーが新しい食品アイテムを追加する, **Then** アイテムが一覧に追加され、合計が更新される
4. **Given** 食品アイテム一覧が表示されている, **When** ユーザーがアイテムを削除する, **Then** アイテムが一覧から削除され、合計が更新される

---

### User Story 2 - AIチャットによる編集支援 (Priority: P2)

ユーザーがAIチャット機能を使って、登録済みの食事内容を会話形式で修正したい。例：「ご飯を半分にして」「デザートを追加して」など。

**Why this priority**: 手動編集より直感的で、登録時と同じ体験を提供する。ただし、P1の手動編集が基盤となるため、P2とする。

**Independent Test**: 既存の食事記録の編集画面でAIチャットを開き、自然言語で変更を指示し、提案された変更を適用できることを確認。

**Acceptance Scenarios**:

1. **Given** 編集画面でAIチャットを開いている, **When** ユーザーが「ご飯を半分にしたい」と入力する, **Then** AIが食品アイテムの変更提案を返し、適用ボタンが表示される
2. **Given** AIが変更提案を表示している, **When** ユーザーが「適用」をタップする, **Then** 食品アイテムが更新され、栄養素合計が再計算される
3. **Given** AIチャットで複数のやり取りをした, **When** ユーザーが編集を保存する, **Then** チャット履歴も保存される

---

### User Story 3 - 写真の追加・変更 (Priority: P3)

ユーザーが食事記録に写真を追加、または既存の写真を別のものに変更したい。

**Why this priority**: 写真は視覚的な記録として有用だが、カロリー管理の正確性には直接影響しないため、P3とする。

**Independent Test**: 写真なしの食事記録に写真を追加できること、または既存の写真を新しいものに差し替えられることを確認。

**Acceptance Scenarios**:

1. **Given** 写真なしの食事記録を編集している, **When** ユーザーが写真を撮影/選択する, **Then** 写真がアップロードされ、記録に紐づく
2. **Given** 写真付きの食事記録を編集している, **When** ユーザーが新しい写真を選択する, **Then** 古い写真が新しい写真に置き換わる

---

### User Story 4 - 編集画面のUI一貫性 (Priority: P1)

編集画面のUIが登録画面と同じコンポーネント・レイアウトを使用し、ユーザーが迷わず操作できるようにする。MealDetailページに「編集」ボタンを設置し、編集モードに切り替える方式を採用する。

**Why this priority**: UIの一貫性はユーザー体験の根幹であり、機能的な編集能力（P1）と同等に重要。

**Independent Test**: MealDetailページから編集モードに入り、登録画面と同じ操作パターンで食品アイテムの操作ができることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーがMealDetailページを表示している, **When** 「編集」ボタンをタップする, **Then** 編集モードに切り替わり、登録時と同じUIコンポーネントが表示される
2. **Given** 編集モードを開いている, **When** 食品アイテムを操作する, **Then** 登録時と同じインタラクションパターンで操作できる
3. **Given** 編集モードで変更を行った, **When** 「保存」ボタンをタップする, **Then** 変更が保存され、表示モードに戻る

---

### Edge Cases

- 編集中に別のユーザー/デバイスから同じ記録が更新された場合、どう処理するか？ → 最後の保存が優先（楽観的ロック）、ただし保存時に警告を表示
- AI分析なしで手動登録した食事を編集する場合は？ → 手動編集のみ可能（AIチャットは利用可能だが、食品アイテムがない状態から開始）
- 編集中にネットワークが切断された場合は？ → ローカルに編集状態を保持し、復帰後に同期
- 写真を削除したい場合は？ → 写真削除ボタンを提供し、確認ダイアログ後に削除

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、AI分析済み食事記録の食品アイテム一覧を編集画面に表示しなければならない
- **FR-002**: ユーザーは、既存の食品アイテムの名前・分量・栄養素を編集できなければならない
- **FR-003**: ユーザーは、食品アイテムを削除できなければならない
- **FR-004**: ユーザーは、新しい食品アイテムを追加できなければならない
- **FR-005**: システムは、食品アイテムの変更時に栄養素合計を自動再計算しなければならない
- **FR-006**: ユーザーは、編集画面からAIチャット機能を利用できなければならない
- **FR-007**: システムは、AIチャットからの変更提案を食品アイテムに適用できなければならない
- **FR-008**: ユーザーは、食事記録に写真を追加または変更できなければならない
- **FR-009**: 編集画面は、登録画面と同じUIコンポーネントを使用しなければならない
- **FR-013**: MealDetailページに「編集」ボタンを表示し、タップで編集モードに切り替えなければならない
- **FR-014**: 編集モードから表示モードへの戻り機能（保存またはキャンセル）を提供しなければならない
- **FR-010**: システムは、編集内容を永続化しなければならない
- **FR-011**: ユーザーは、手動登録した食事（食品アイテムなし）に対してもAIチャットを利用できなければならない
- **FR-012**: ユーザーは、食事記録から写真を削除できなければならない

### Key Entities

- **MealRecord（食事記録）**: 食事の基本情報（種類、内容テキスト、写真、記録日時、栄養素合計）
- **FoodItem（食品アイテム）**: 個別の食品（名前、分量、カロリー、タンパク質、脂質、炭水化物）。1つの食事記録に複数紐づく
- **ChatMessage（チャットメッセージ）**: AIとの会話履歴。変更提案と適用結果を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは食品アイテムの編集操作（追加・変更・削除）を5秒以内に完了できる
- **SC-002**: 編集画面から登録時と同等の機能（食品アイテム操作、AIチャット）にアクセスできる
- **SC-003**: 食品アイテム変更後、栄養素合計が1秒以内に自動更新される
- **SC-004**: AIチャットからの変更提案が、登録時と同じ精度で適用できる
- **SC-005**: 編集操作の完了率（編集開始から保存まで）が90%以上

## Assumptions

- 既存のAI分析・チャット機能は正常に動作しており、編集画面への統合で再利用可能
- 食品アイテムの編集APIは既に存在する（登録時に使用されているもの）
- オフライン編集は既存のIndexedDBインフラを活用できる
- 写真のストレージ（R2）への操作権限は既存のものを流用できる

## Out of Scope

- 食事記録の一括編集機能
- 過去の編集履歴の閲覧・復元機能
- 他ユーザーとの食事記録共有機能
- 写真からの再AI分析（新規写真での再分析は別機能として検討）
