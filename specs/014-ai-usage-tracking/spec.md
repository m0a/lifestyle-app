# Feature Specification: AI利用量トラッキング

**Feature Branch**: `014-ai-usage-tracking`
**Created**: 2026-01-04
**Status**: Draft
**Input**: User description: "とりあえずアカウント設定の箇所でAIの利用量を把握できるようにしたい。後々利用制限をつけるための布石として。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AI利用トークン量の確認 (Priority: P1)

ユーザーとして、アカウント設定画面で自分がどれくらいAI機能を利用しているかトークン量で確認したい。質問の長さや回答の長さによって利用料が変わるため、トークン量で把握することで実際のコストを理解できる。

**Why this priority**: トークン量の可視化は将来の利用制限機能の基盤となる最も重要な機能。回数ではなくトークン量が実際の利用料に直結する。

**Independent Test**: 設定ページ(/settings)にアクセスし、「AI利用状況」セクションが表示され、利用トークン量が数値で確認できる

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザーがいる, **When** 設定ページにアクセスする, **Then** AI利用状況セクションが表示される
2. **Given** ユーザーがAI機能を使用した, **When** 設定ページを確認する, **Then** 使用したトークン量が正確に表示されている
3. **Given** ユーザーがAI機能を一度も使用していない, **When** 設定ページを確認する, **Then** トークン量が0と表示される

---

### User Story 2 - 期間別トークン利用量の確認 (Priority: P2)

ユーザーとして、今月のAI利用トークン量を確認したい。これにより、月次の利用傾向を把握できる。

**Why this priority**: 将来的な月次利用制限の基盤となる。P1の累計表示があれば最低限機能するため優先度を下げる。

**Independent Test**: 設定ページで「今月」のトークン利用量が累計とは別に表示される

**Acceptance Scenarios**:

1. **Given** ユーザーが今月AI機能で10,000トークン使用した, **When** 設定ページを確認する, **Then** 今月のトークン量が10,000と表示される
2. **Given** 月が変わった, **When** 設定ページを確認する, **Then** 今月のトークン量がリセットされ0から始まる

---

### User Story 3 - AI機能種別ごとの利用量確認 (Priority: P3) - DEFERRED

ユーザーとして、食事分析・AIチャットなど機能別のトークン使用量を確認したい。

**Why this priority**: 詳細な内訳は初期リリースでは不要。P1/P2で基本的な利用量把握は達成できる。

**DEFERRED**: 将来のフェーズで実装予定

---

### Edge Cases

- 複数デバイスから同時にAI機能を使用した場合でも正確にカウントされること
- AI分析がエラーになった場合のカウント方針（成功時のみカウント）
- 過去データの移行：実装前の利用データはカウントに含めない（実装後からカウント開始）
- トークン量が非常に大きくなった場合の表示形式（例: 1,234,567 → 1.2M tokens）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはAI機能（食事画像分析、テキスト分析、AIチャット）の利用トークン量を記録しなければならない
- **FR-002**: システムは入力トークン数と出力トークン数の両方を記録しなければならない
- **FR-003**: システムは各利用の日時を記録しなければならない
- **FR-004**: 設定ページにAI利用状況セクションを表示しなければならない
- **FR-005**: 累計トークン利用量を表示しなければならない
- **FR-006**: 今月のトークン利用量を表示しなければならない
- **FR-007**: AI分析が成功した場合のみトークン量としてカウントする（エラー時はカウントしない）
- **FR-008**: トークン利用データはユーザーごとに管理する
- **FR-009**: トークン量は読みやすい形式で表示する（例: 1,234 tokens、1.2M tokens）

### Key Entities

- **AIUsageRecord**: AI機能利用の記録。ユーザーID、利用日時、機能種別（image_analysis, text_analysis, chat）、入力トークン数、出力トークン数を含む
- **AIUsageSummary**: 集計されたAI利用統計。累計トークン量、今月のトークン量を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは設定ページで2秒以内にAI利用統計を確認できる
- **SC-002**: AI機能利用後、次回の設定ページアクセス時に更新されたトークン量が反映される
- **SC-003**: トークン量の集計精度が100%である（漏れなく記録される）

## Assumptions

- AI利用量の記録は実装後から開始し、過去の利用データは含めない
- 利用制限機能は別フェーズで実装予定（本仕様の範囲外）
- 機能種別ごとの内訳表示はP3として将来実装予定（本フェーズでは実装しない）
- 利用統計の保持期間は無期限（将来的に見直し可能）
- 入力トークンと出力トークンは合算して「総トークン量」として表示する（内訳表示は将来検討）
