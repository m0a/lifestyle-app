# Feature Specification: PR Preview Environment

**Feature Branch**: `002-pr-preview-env`
**Created**: 2026-01-01
**Status**: Draft
**Input**: User description: "PR毎にプレビュー環境を作りたい。issue#1参照"

## User Scenarios & Testing *(mandatory)*

### User Story 0 - mainブランチのプレビュー環境 (Priority: P0)

mainブランチにマージされると、常に最新のmainを反映したプレビュー環境が更新される。本番リリース前に最新の統合状態を確認できる。

**Why this priority**: 本番デプロイ前の最終確認環境。複数PRがマージされた後の統合状態を確認できる。

**Independent Test**: PRをマージし、mainプレビュー環境が更新されることを確認する。

**Acceptance Scenarios**:

1. **Given** PRがmainにマージされた状態, **When** CIが実行される, **Then** mainプレビュー環境が最新コードで更新される
2. **Given** mainプレビュー環境が存在する状態, **When** ユーザーがアクセス, **Then** mainブランチの最新状態が表示される
3. **Given** mainプレビュー環境, **When** マイグレーションがある場合, **Then** プレビューDBにマイグレーションが適用される

---

### User Story 0.5 - タグベースの本番リリース (Priority: P0)

開発者がリリース準備ができたら、GitタグをプッシュすることでCloudflare Workersに本番デプロイされる。mainブランチへのプッシュではデプロイされず、明示的なタグ付けでのみリリースが行われる。

**Why this priority**: デプロイ制御の基盤。意図しない本番デプロイを防ぎ、リリースタイミングを明確に管理できる。

**Independent Test**: `v1.0.0`形式のタグをプッシュし、本番環境にデプロイされることを確認する。

**Acceptance Scenarios**:

1. **Given** mainブランチにコードがマージされた状態, **When** タグなしでプッシュ, **Then** 本番デプロイは実行されない
2. **Given** リリース準備ができた状態, **When** `v*`形式のタグをプッシュ, **Then** 本番DBにマイグレーションが適用され、本番環境にデプロイされる
3. **Given** タグがプッシュされた状態, **When** CI/テストが失敗, **Then** デプロイはスキップされる

---

### User Story 1 - PRレビュー時のプレビュー確認 (Priority: P1)

開発者がPRを作成すると、自動的にプレビュー環境がデプロイされ、PRコメントにプレビューURLが投稿される。レビュアーは実際に動作を確認しながらコードレビューができる。

**Why this priority**: PRレビューの品質向上が最大の価値。コードだけでなく実際の動作を確認できることで、UIの問題やユーザー体験の課題を早期発見できる。

**Independent Test**: PRを作成し、プレビューURLが投稿され、そのURLでアプリが動作することを確認する。

**Acceptance Scenarios**:

1. **Given** PRが作成された状態, **When** CIが実行される, **Then** プレビュー環境が自動デプロイされる
2. **Given** プレビュー環境がデプロイされた状態, **When** デプロイ完了, **Then** PRにプレビューURLがコメントとして投稿される
3. **Given** プレビューURLが投稿された状態, **When** レビュアーがURLにアクセス, **Then** PRの変更が反映されたアプリが表示される

---

### User Story 2 - PRマージ後のプレビュー環境クリーンアップ (Priority: P2)

PRがマージまたはクローズされると、対応するプレビュー環境が自動的に削除される。これにより、不要なリソースが残らず、コスト管理が容易になる。

**Why this priority**: リソース管理とコスト最適化のため。プレビュー環境が溜まり続けると管理が煩雑になる。

**Independent Test**: PRをマージし、プレビュー環境が削除されることを確認する。

**Acceptance Scenarios**:

1. **Given** PRプレビュー環境が存在するPR, **When** PRがマージされる, **Then** PRプレビュー環境が削除される（mainプレビューは別途更新）
2. **Given** PRプレビュー環境が存在するPR, **When** PRがクローズされる, **Then** PRプレビュー環境が削除される

---

### User Story 3 - PRコミット更新時のプレビュー再デプロイ (Priority: P3)

PRに新しいコミットがプッシュされると、プレビュー環境が自動的に更新される。常に最新の変更がプレビューに反映される。

**Why this priority**: 継続的なレビューのため。修正を重ねるたびに最新状態を確認できる。

**Independent Test**: PRに追加コミットをプッシュし、プレビュー環境が更新されることを確認する。

**Acceptance Scenarios**:

1. **Given** プレビュー環境が存在するPR, **When** 新しいコミットがプッシュされる, **Then** プレビュー環境が最新コードで更新される
2. **Given** プレビュー更新が完了した状態, **When** レビュアーがURLにアクセス, **Then** 最新の変更が反映されている

---

### Edge Cases

- CIテストが失敗した場合、プレビューデプロイはスキップされる（テスト成功後のみデプロイ）
- 同時に複数のPRがある場合、各PRに独立したプレビュー環境が作成される
- プレビュー環境のデプロイが失敗した場合、PRにエラーメッセージがコメントされる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-000a**: システムは、mainブランチにプッシュされたとき、mainプレビュー環境を最新コードで更新しなければならない
- **FR-000b**: システムは、`v*`形式のタグがプッシュされたとき、本番DBにマイグレーションを適用し、本番環境にデプロイしなければならない
- **FR-001**: システムは、mainブランチへのPRが作成されたとき、自動的にPRプレビュー環境をデプロイしなければならない
- **FR-002**: システムは、デプロイ完了後、PRにプレビューURLをコメントとして投稿しなければならない
- **FR-003**: システムは、各PRに対して一意のプレビュー環境を作成しなければならない（PR番号またはブランチ名で識別）
- **FR-004**: システムは、PRがマージまたはクローズされたとき、対応するPRプレビュー環境を削除しなければならない
- **FR-005**: システムは、PRに新しいコミットがプッシュされたとき、プレビュー環境を更新しなければならない
- **FR-006**: プレビュー環境は、本番環境と同等の機能を提供しなければならない（データベースは分離）
- **FR-007**: プレビュー環境は、専用のプレビューデータベース（本番とは別のD1インスタンス）を使用しなければならない

### Key Entities

- **Main Preview Environment**: mainブランチの最新状態を反映する常設プレビュー環境。固定URL。
- **PR Preview Environment**: PRに対応する一時的なデプロイ環境。PR番号で識別、マージ/クローズ時に削除。
- **PR Comment**: プレビューURLを通知するGitHubコメント。デプロイ成功/失敗のステータスを含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-000**: タグプッシュから5分以内に本番環境にデプロイが完了する
- **SC-001**: PRが作成されてから5分以内にプレビュー環境がアクセス可能になる
- **SC-002**: PRがマージ/クローズされてから10分以内にプレビュー環境が削除される
- **SC-003**: プレビュー環境のデプロイ成功率が95%以上
- **SC-004**: レビュアーがプレビューURLから直接変更内容を確認できる

## Assumptions

- Cloudflare Workersのプレビューデプロイ機能を使用する
- URL構成（workers.devサブドメイン）:
  - 本番: `lifestyle-tracker.abe00makoto.workers.dev`
  - mainプレビュー: `lifestyle-tracker-preview.abe00makoto.workers.dev`
  - PRプレビュー: `lifestyle-tracker-pr-{番号}.abe00makoto.workers.dev`
- 全プレビュー環境で共有の専用プレビューD1データベースを使用（本番とは別インスタンス）
- プレビューDBのデータはリセットしない（マイグレーション互換性の検証に使用）
- mainマージ時にマイグレーションを適用してスキーマを最新に保つ
- GitHub Actionsのworkflowスコープ権限が設定済み
- プレビュー環境の同時最大数はCloudflareの無料枠内に収まる想定

## Clarifications

### Session 2026-01-01

**Q: プレビュー環境のデータベース分離戦略**

検討した選択肢:
- A案: PR毎に新しいD1インスタンス作成 → Cloudflare制限・コスト懸念
- B案: 共有D1 + テーブルプレフィックス → Drizzleスキーマ変更が必要
- C案: 共有D1 + SQLiteファイル分離 → D1の仕様上不可
- D案: 共有D1（データ永続） → シンプル、選択

**決定**: D案を採用。全プレビュー環境で1つのプレビュー専用D1を共有。データはリセットせず永続化し、マイグレーション互換性の検証にも活用する。

**Q: 本番デプロイのトリガー**

現状: mainブランチへのプッシュで自動デプロイ

**決定**: タグベースリリースに変更。`v*`形式のタグプッシュでのみ本番デプロイ。mainプッシュではCI/テストのみ実行。意図的なリリース管理が可能になる。

**Q: mainプレビュー環境の追加**

**決定**: mainブランチにマージされたとき、mainプレビュー環境を更新する。これにより:
- 複数PRマージ後の統合状態を確認できる
- プレビューDBにマイグレーションが適用される（データリセットなし）
- 既存データに対するマイグレーション互換性を検証できる
- 本番リリース前の最終確認環境として機能する

**Q: 本番デプロイ時のマイグレーション**

**決定**: タグプッシュによる本番デプロイ時、デプロイ前に本番DBにマイグレーションを適用する。プレビュー環境で検証済みのマイグレーションが本番に適用される流れ。

**Q: プレビュー環境のURL構成**

**決定**: workers.devサブドメインを使用。カスタムドメインは不要。
- 本番: `lifestyle-tracker.abe00makoto.workers.dev`
- mainプレビュー: `lifestyle-tracker-preview.abe00makoto.workers.dev`（`--env preview`）
- PRプレビュー: `lifestyle-tracker-pr-{番号}.abe00makoto.workers.dev`（`--name`で動的生成）
