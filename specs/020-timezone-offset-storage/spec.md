# Feature Specification: Timezone Offset Storage

**Feature Branch**: `020-timezone-offset-storage`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: "recordedAtにタイムゾーンオフセットを含めて保存する方式への移行"
**Related Issue**: #66

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 記録時のタイムゾーン保持 (Priority: P1)

ユーザーが体重・食事・運動を記録する際、記録した場所のタイムゾーン情報がデータと共に保存される。これにより、海外旅行中に記録したデータも、記録した現地時刻で正確に表示される。

**Why this priority**: タイムゾーン情報の保存は本機能の根幹であり、これがなければ他の機能が成り立たない。

**Independent Test**: 日本で記録したデータと海外で記録したデータが、それぞれの現地時刻で正しく保存・表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが日本（JST）にいる, **When** 体重を記録する, **Then** 記録データに `+09:00` オフセットが含まれる
2. **Given** ユーザーがニューヨーク（EST）にいる, **When** 食事を記録する, **Then** 記録データに `-05:00` オフセットが含まれる
3. **Given** 記録時のオフセットが保存されている, **When** データを表示する, **Then** 記録時のローカル時刻で表示される

---

### User Story 2 - 既存データのマイグレーション (Priority: P1)

既存のUTC形式で保存されているデータが、適切なタイムゾーンオフセット（JST: +09:00）付きの形式に変換される。これにより、過去のデータも新しい表示ロジックで正しく表示される。

**Why this priority**: 既存データとの互換性がなければ、ユーザーの過去の記録が正しく表示されなくなる。

**Independent Test**: マイグレーション実行後、既存の全てのデータが正しいオフセット付き形式に変換されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** 既存データが `2026-01-17T08:00:00Z` 形式で保存されている, **When** マイグレーションを実行する, **Then** データが `2026-01-17T17:00:00+09:00` 形式に変換される
2. **Given** マイグレーション済みのデータ, **When** ダッシュボードで表示する, **Then** 正しい日付にデータが表示される

---

### User Story 3 - ダッシュボードでの正確な日付表示 (Priority: P2)

ダッシュボードのドットグリッドで、記録データが記録時のタイムゾーンに基づいた正しい日付に表示される。朝8時前に記録した体重が前日として表示される問題が解消される。

**Why this priority**: ユーザー体験の改善であり、P1の機能が完成した後に自然と実現される。

**Independent Test**: 朝7時（JST）に記録した体重が、その日のドットとして表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** `2026-01-17T07:00:00+09:00` に体重を記録した, **When** ダッシュボードを表示する, **Then** 1/17のドットに体重データが含まれる
2. **Given** 複数の異なるタイムゾーンで記録したデータがある, **When** ダッシュボードを表示する, **Then** 各データが記録時のローカル日付で表示される

---

### User Story 4 - 表示タイムゾーン切り替え（将来拡張） (Priority: P3)

ユーザーが設定画面で「現在地の時刻で表示する」オプションを選択できる。これにより、記録時のタイムゾーンではなく、現在地のタイムゾーンで全てのデータを表示できる。

**Why this priority**: 基本機能（P1/P2）が完成した後のオプション機能であり、必須ではない。

**Independent Test**: 設定を切り替えることで、同じデータが異なるタイムゾーンで表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 「現在地の時刻で表示」がOFF, **When** データを表示する, **Then** 記録時のタイムゾーンで表示される
2. **Given** 「現在地の時刻で表示」がON, **When** 海外で記録したデータを日本で表示する, **Then** JSTに変換されて表示される

---

### Edge Cases

- 夏時間（DST）が適用される地域で記録した場合、オフセットが正しく保存されるか？
- タイムゾーンが変更になった地域（例：サモア）の過去データはどう扱うか？
- オフセットが欠落したデータが送信された場合のエラーハンドリング

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは記録データ（体重・食事・運動）の `recordedAt` フィールドにISO 8601形式のタイムゾーンオフセット（例: `+09:00`）を含めて保存しなければならない
- **FR-002**: システムはオフセットなしの日時データを拒否し、エラーメッセージを返さなければならない
- **FR-003**: クライアントアプリケーションは記録時にユーザーのローカルタイムゾーンのオフセットを自動的に付与しなければならない
- **FR-004**: 既存のUTC形式データは、マイグレーションによりJST（`+09:00`）オフセット付き形式に変換されなければならない
- **FR-005**: データ表示時は、デフォルトで記録時のタイムゾーンを使用して日時を表示しなければならない
- **FR-006**: ダッシュボードの日付グルーピングは、`recordedAt` の先頭10文字（ローカル日付）を使用しなければならない
- **FR-007**: システムはPR #65で追加された表示時タイムゾーン送信ロジックを削除し、シンプル化しなければならない

### Key Entities

- **recordedAt**: 記録日時を表すISO 8601形式の文字列。タイムゾーンオフセットを含む（例: `2026-01-17T08:00:00+09:00`）
- **weight_records / meal_records / exercise_records**: 各記録テーブル。`recorded_at` カラムの形式が変更される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 新規記録の100%がタイムゾーンオフセット付きで保存される
- **SC-002**: 既存データの100%がマイグレーションにより正しいオフセット付き形式に変換される
- **SC-003**: 朝8時前に記録したデータが、100%正しい日付で表示される（従来の問題が解消）
- **SC-004**: 表示時のタイムゾーン送信APIコールが削除され、ネットワークリクエストが簡素化される
- **SC-005**: ユーザーは記録した場所の文脈を維持したまま、過去のデータを閲覧できる

## Assumptions

- 既存の全データは日本国内（JST）で記録されたものとする
- date-fns-tzライブラリをフロントエンドに追加して使用する
- DBスキーマの変更は不要（recordedAtカラムの値の形式のみ変更）
- 夏時間（DST）の扱いは、記録時点のオフセットをそのまま保存することで対応する

## Out of Scope

- ユーザーごとのデフォルトタイムゾーン設定機能
- 過去のデータに対する手動タイムゾーン修正機能
- タイムゾーン変換の詳細なログ記録
