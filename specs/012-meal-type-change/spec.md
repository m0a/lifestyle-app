# Feature Specification: 食事タイプの変更機能

**Feature Branch**: `012-meal-type-change`
**Created**: 2026-01-03
**Status**: Draft
**Input**: User description: "食事タイプの変更を可能にする"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AIチャットで食事タイプを変更する (Priority: P1)

ユーザーが食事記録の詳細画面でAIチャットを使って「朝ごはんとして記録して」「これは夕食です」などと伝えることで、食事タイプ（朝食/昼食/夕食/間食）を変更できる。

**Why this priority**: 現在ユーザーがAIに食事タイプの変更を依頼しても、実際には変更されない問題が発生している。これはユーザー体験を大きく損なう根本的な問題であり、最優先で解決する必要がある。

**Independent Test**: AIチャットで「朝食に変更して」と入力し、食事タイプが実際に「朝食」に変更されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 食事詳細画面でAIチャットを開いている状態, **When** ユーザーが「朝ごはんとして記録して」と入力する, **Then** AIが食事タイプ変更の提案を表示し、適用後に食事タイプが「朝食」に変更される
2. **Given** 昼食として記録された食事の詳細画面, **When** ユーザーが「これは夕食でした」と入力する, **Then** AIが食事タイプを「夕食」に変更する提案を表示する
3. **Given** AIから食事タイプ変更の提案が表示されている状態, **When** ユーザーが「適用する」ボタンをタップする, **Then** 食事タイプが変更され、画面上の表示が更新される

---

### User Story 2 - 日時と食事タイプを同時に変更する (Priority: P2)

ユーザーが「昨日の朝食として記録して」のように日時と食事タイプを同時に指定した場合、両方が正しく変更される。

**Why this priority**: 日時変更機能は既に存在するため、食事タイプ変更との組み合わせは自然な拡張であり、ユーザーの期待に応えるために必要。

**Independent Test**: AIチャットで「昨日の夕食として記録して」と入力し、日時と食事タイプの両方が変更されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 本日の昼食として記録された食事, **When** ユーザーが「昨日の朝食として記録して」と入力する, **Then** 日時が昨日の08:00に、食事タイプが「朝食」に変更される提案が表示される
2. **Given** AIから日時と食事タイプ両方の変更提案が表示されている状態, **When** ユーザーが「適用する」ボタンをタップする, **Then** 両方の変更が適用され、画面表示が更新される

---

### User Story 3 - 変更提案の確認とキャンセル (Priority: P3)

ユーザーはAIからの食事タイプ変更提案を確認し、不要であればキャンセルできる。

**Why this priority**: ユーザーが意図しない変更を防ぐための安全機能として必要。

**Independent Test**: AIチャットで食事タイプ変更を依頼し、表示された提案を「キャンセル」することで元の状態を維持できることを確認。

**Acceptance Scenarios**:

1. **Given** AIから食事タイプ変更の提案が表示されている状態, **When** ユーザーが「キャンセル」ボタンをタップする, **Then** 提案が破棄され、食事タイプは変更されない
2. **Given** AIから変更提案が表示されている状態, **When** 提案内容に「食事タイプ変更: 昼食 → 朝食」のように分かりやすく表示される, **Then** ユーザーは変更内容を理解した上で判断できる

---

### Edge Cases

- ユーザーが現在と同じ食事タイプへの変更を要求した場合 → 「既に朝食として記録されています」と通知し、変更提案は出さない
- 無効な食事タイプを指定した場合（例: 「夜食として記録」） → 最も近い有効な食事タイプを推測して提案する（夜食 → 夕食または間食）
- AIが食事タイプの変更意図を誤認識した場合 → ユーザーは提案をキャンセルして再度指示できる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは朝食(breakfast)、昼食(lunch)、夕食(dinner)、間食(snack)の4種類の食事タイプ間で変更をサポートしなければならない
- **FR-002**: AIチャットは「朝食」「朝ごはん」「breakfast」など、食事タイプを示す自然言語表現を認識しなければならない
- **FR-003**: システムは食事タイプ変更の提案を他の変更（食材追加、日時変更など）と同様の形式で表示しなければならない
- **FR-004**: ユーザーは変更提案を適用またはキャンセルできなければならない
- **FR-005**: 食事タイプの変更はデータベースに永続化されなければならない
- **FR-006**: 変更適用後、画面上の食事タイプ表示は即座に更新されなければならない
- **FR-007**: システムは日時変更と食事タイプ変更を同時に処理できなければならない

### Key Entities

- **MealRecord**: 食事記録エンティティ。`mealType`属性（breakfast/lunch/dinner/snack）を持ち、この値が変更対象となる
- **ChatChange**: AIチャットからの変更提案を表すエンティティ。既存の`add`/`remove`/`update`/`set_datetime`アクションに加え、`set_meal_type`アクションが追加される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがAIチャットで食事タイプの変更を依頼した場合、95%以上の精度で正しく認識される
- **SC-002**: 食事タイプ変更の操作は3タップ以内（メッセージ送信 → 適用ボタン押下）で完了できる
- **SC-003**: 変更提案の表示から適用完了まで2秒以内で処理される
- **SC-004**: 食事タイプ変更機能追加後、「食事タイプを変更できない」に関する問い合わせが0件になる

## Assumptions

- 食事タイプは既存の4種類（breakfast/lunch/dinner/snack）のみをサポートする
- 食事タイプ変更時、関連する日時は自動変更しない（ユーザーが明示的に指定した場合のみ変更）
- AIチャットの既存のUI/UX（変更提案の表示形式、適用/キャンセルボタンなど）を踏襲する
- 「夜食」「ブランチ」などの非標準的な表現は最も近い食事タイプにマッピングする
