# Feature Specification: AI食事写真カロリー分析

**Feature Branch**: `001-ai-meal-calorie-analysis`
**Created**: 2026-01-01
**Status**: Draft
**Input**: User description: "食事記録にてカロリー計測をAIで実施できるようにしたい。写真を撮って送ることで食事内容とカロリー等を計算させたい。"

## Clarifications

### Session 2026-01-01

- Q: 写真のストレージと保持期間は？ → A: 分析用の高解像度写真は分析完了後に削除。食事記録として低解像度の写真を永続保存し、記録削除時に写真も連動して削除。
- Q: カロリー・栄養素データの取得元は？ → A: AIモデルに内蔵された栄養知識のみで推定（外部データベース不使用）。
- Q: 食材の量の指定方法は？ → A: 相対サイズ（小盛り/普通/大盛り等）で指定。記録をカジュアルにして習慣化を優先。
- Q: AI分析の実行環境は？ → A: 外部AIサービス（マルチモーダルLLM）を利用。モデル切り替え可能な設計とし、コスト最適化を重視。
- Q: AI分析の信頼度が低い場合の扱いは？ → A: 信頼度に関わらず全て同等に表示（シンプル優先）。微調整が必要な場合はチャットで対応。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 食事写真からカロリー分析 (Priority: P1)

ユーザーは食事の写真を撮影またはアップロードし、AIがその写真から食事内容を識別してカロリーや栄養素を自動計算する。計算結果を確認し、必要に応じて修正した上で食事記録として保存できる。

**Why this priority**: これが本機能の核心的な価値であり、ユーザーが手動でカロリーを調べる手間を大幅に削減する。この機能なしでは本フィーチャーの意味がない。

**Independent Test**: 1枚の食事写真をアップロードし、カロリーと栄養素の推定結果が表示され、食事記録として保存できることで完全にテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがログイン済みで食事記録画面にいる, **When** 食事の写真を撮影/アップロードする, **Then** AIが食事内容を識別し、推定カロリーと主要栄養素（タンパク質・脂質・炭水化物）が表示される
2. **Given** AI分析結果が表示されている, **When** ユーザーが結果を確認して保存ボタンを押す, **Then** 分析結果が食事記録として保存される
3. **Given** AI分析結果が表示されている, **When** ユーザーが食事内容や量を修正する, **Then** 修正に応じてカロリーと栄養素が再計算される

---

### User Story 2 - 分析結果の修正と調整 (Priority: P2)

AIの分析結果が正確でない場合、ユーザーは食材の追加・削除・量の調整を行い、正確な記録を作成できる。

**Why this priority**: AIの精度は100%ではないため、ユーザーが修正できる仕組みは実用性のために不可欠。ただしP1がなければ修正対象がない。

**Independent Test**: AI分析後に食材を手動で追加/削除/量変更し、カロリーが再計算されることで単独テスト可能。

**Acceptance Scenarios**:

1. **Given** AI分析結果に「ご飯」が含まれている, **When** ユーザーが量を「普通盛り」から「大盛り」に変更する, **Then** カロリーと栄養素が大盛り用に再計算される
2. **Given** AI分析結果が表示されている, **When** ユーザーが認識されていない食材（味噌汁など）を追加する, **Then** 追加食材のカロリーが合計に加算される
3. **Given** AI分析結果に誤認識された食材がある, **When** ユーザーがその食材を削除する, **Then** 削除された食材のカロリーが合計から除外される

---

### User Story 3 - チャットで食事内容を相談・調整 (Priority: P2)

ユーザーはAI分析結果を見ながら、チャット形式でAIに相談して食事内容を調整できる。「ご飯を半分にしたい」「これをサラダに置き換えたらどうなる？」などの自然な会話で、食材の変更や代替案の提案を受けられる。

**Why this priority**: 手動での修正（User Story 2）を補完し、より直感的で柔軟な調整方法を提供する。特に栄養バランスの相談や代替食材の提案など、単純な追加・削除では対応しにくいケースに価値がある。

**Independent Test**: AI分析結果画面でチャットを開始し、「ご飯を減らしたい」と入力して、AIが提案した変更を適用できることで単独テスト可能。

**Acceptance Scenarios**:

1. **Given** AI分析結果が表示されている, **When** ユーザーがチャットで「ご飯を半分にしたい」と入力する, **Then** AIが変更を提案し、承認するとカロリーが再計算される
2. **Given** AI分析結果が表示されている, **When** ユーザーが「もっとタンパク質を増やすには？」と質問する, **Then** AIが現在の食事に基づいた代替案や追加食材を提案する
3. **Given** チャットでAIが食材の置き換えを提案している, **When** ユーザーが提案を承認する, **Then** 食材リストが更新され、カロリーと栄養素が再計算される
4. **Given** チャット中にユーザーが複数の変更を相談している, **When** 会話が終了する, **Then** チャット履歴が食事記録と共に保存される

---

### User Story 4 - 分析履歴の確認 (Priority: P3)

ユーザーは過去にAI分析で記録した食事の履歴を確認し、写真と共に振り返ることができる。

**Why this priority**: 記録した情報を活用するために必要だが、まず記録機能（P1, P2）が動作することが前提。

**Independent Test**: 過去の食事記録一覧を開き、写真と分析結果が表示されることで単独テスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがAI分析で複数の食事を記録済み, **When** 履歴画面を開く, **Then** 日付順に食事写真と記録されたカロリーの一覧が表示される
2. **Given** 履歴一覧が表示されている, **When** 特定の記録をタップする, **Then** その食事の詳細（写真、識別された食材、各栄養素）が表示される

---

### Edge Cases

- 食事以外の写真（風景、人物など）をアップロードした場合はどうなるか？ → 「食事を識別できませんでした」とエラーメッセージを表示し、再撮影を促す
- 複数の料理が1枚の写真に写っている場合はどうなるか？ → 識別可能な全ての料理を個別にリストアップして合計カロリーを表示
- 暗い・ぼやけた写真の場合はどうなるか？ → 分析精度が低い可能性を警告し、再撮影を推奨するが、可能な範囲で分析を試みる
- ネットワーク接続がない場合はどうなるか？ → オフラインであることを通知し、接続回復後に分析するか、後で分析するために写真を保存するオプションを提供
- 非常に珍しい料理や地域特有の料理の場合はどうなるか？ → 類似料理として推定するか、「不明な料理」として手動入力を促す
- チャットで食事と無関係な質問をされた場合はどうなるか？ → 食事内容の調整に関する質問のみ対応可能であることを案内し、話題を食事に戻すよう促す
- チャットでAIが提案した変更をユーザーが拒否した場合はどうなるか？ → 別の代替案を提案するか、元の状態を維持して会話を続ける
- チャット中にネットワークが切断された場合はどうなるか？ → 入力中のメッセージを保持し、接続回復後に送信を再試行する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは食事写真をアップロードまたはカメラ撮影で受け取れなければならない
- **FR-002**: システムはアップロードされた写真からAIを使用して食事内容を識別しなければならない
- **FR-003**: システムは識別された各食材について推定カロリーを表示しなければならない
- **FR-004**: システムは識別された各食材について主要栄養素（タンパク質・脂質・炭水化物）を表示しなければならない
- **FR-005**: ユーザーはAI分析結果の食材リストを編集（追加・削除・量の変更）できなければならない
- **FR-006**: システムは食材の編集に応じてカロリーと栄養素を再計算しなければならない
- **FR-007**: ユーザーは分析結果を食事記録として保存できなければならない
- **FR-008**: システムは保存された食事記録を写真と共に履歴として表示しなければならない
- **FR-009**: システムは食事と認識できない写真に対してエラーメッセージを表示しなければならない
- **FR-010**: システムは分析中に進行状況をユーザーに表示しなければならない
- **FR-011**: ユーザーはAI分析結果画面からチャット機能を開始できなければならない
- **FR-012**: システムはチャットで自然言語による食事内容の調整リクエストを理解しなければならない
- **FR-013**: システムはチャットで食材の代替案や量の調整を提案できなければならない
- **FR-014**: ユーザーはチャットで提案された変更を承認または拒否できなければならない
- **FR-015**: システムはチャットで承認された変更を食材リストに反映しなければならない
- **FR-016**: システムはチャット履歴を食事記録と共に保存しなければならない

### Key Entities

- **食事記録 (MealRecord)**: ユーザーが記録した1回の食事。記録日時、食事タイプ（朝食/昼食/夕食/間食）、写真、合計カロリー、合計栄養素を含む
- **食材分析結果 (FoodItem)**: AI が識別した個々の食材。食材名、推定量（相対サイズ）、カロリー、タンパク質、脂質、炭水化物を含む。信頼度はユーザーに表示しない
- **食事写真 (MealPhoto)**: 食事記録用に低解像度化された写真データ。食事記録と連動して管理され、記録削除時に同時削除。分析用の高解像度写真は分析完了後に破棄
- **チャット履歴 (ChatHistory)**: 食事記録に関するAIとの会話履歴。各メッセージの送信者（ユーザー/AI）、内容、タイムスタンプ、適用された変更の参照を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは写真アップロードから分析結果表示まで10秒以内に完了できる
- **SC-002**: AI分析の主要食材識別精度が80%以上（ユーザーが修正せずに保存した記録の割合で測定）
- **SC-003**: ユーザーは写真撮影から食事記録保存まで30秒以内に完了できる
- **SC-004**: 分析結果の修正操作（食材追加・削除・量変更）が1操作あたり3秒以内に完了できる
- **SC-005**: 記録された食事の80%以上がAI分析機能を経由して作成される（機能の採用率）
- **SC-006**: チャットでの質問に対するAI応答が5秒以内に表示される
- **SC-007**: チャット経由で行われた食事調整の70%以上がユーザーに承認される（提案の適切性）

## Assumptions

- ユーザーは既にlifestyle-appのアカウントを持ち、ログイン済みである
- 食事記録機能は既存の機能として存在し、本機能はそれを拡張する形で追加される
- インターネット接続が利用可能な環境での使用を主に想定する
- カロリー・栄養素の推定はAIモデルの内蔵知識に基づき、外部データベースは使用しない
- カロリー・栄養素の値は概算であり、医療・専門的な用途での使用は想定しない
- 記録の習慣化を優先し、入力の手軽さ・カジュアルさを重視する設計方針とする
- 写真は一般的なスマートフォンカメラ品質（5MP以上）を想定する
- AI分析は外部マルチモーダルLLMサービスを利用し、モデル切り替え可能な抽象化層を設ける
- AIサービスのコスト最適化を重視し、モデル選定時は精度とコストのバランスを考慮する

## Out of Scope

- バーコードスキャンによる食品識別
- 音声入力による食事記録
- 他ユーザーとの食事記録共有
- 長期的な食事計画や健康アドバイスの生成（チャットは当該食事の調整のみ対応）
- オフライン時のAI分析（オフライン時は写真保存のみ）
