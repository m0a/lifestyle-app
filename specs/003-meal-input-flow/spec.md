# Feature Specification: 食事入力フローの改善

**Feature Branch**: `003-meal-input-flow`
**Created**: 2026-01-01
**Status**: Draft
**Input**: User description: "食事入力フローの改善"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - シンプルなテキスト入力でAI自動計算 (Priority: P1)

ユーザーが食事ページで「ラーメン」と入力するだけで、AIが自動的にカロリーと栄養素を計算し、食事記録として保存できる。現在の複雑な6ステップフローを1-2ステップに簡略化する。

**Why this priority**: 最も頻繁に使われる機能であり、ユーザー体験の根幹。現在のフローが複雑すぎてユーザーが離脱するリスクが高い。

**Independent Test**: 食事ページのテキスト入力欄に「カレーライス」と入力し、AIがカロリーを自動計算して記録できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが食事記録ページにいる状態, **When** 食事内容を入力して送信, **Then** AIがカロリー・栄養素を自動計算して表示する
2. **Given** AIがカロリーを計算した状態, **When** ユーザーが「記録する」をクリック, **Then** 食事記録として保存される
3. **Given** 計算結果が表示された状態, **When** ユーザーがカロリー値を手動で修正, **Then** 修正した値で保存できる

---

### User Story 2 - 自然言語での食事タイプ自動判定 (Priority: P2)

ユーザーが「昼にラーメン食べた」のように自然言語で入力すると、AIが食事タイプ（朝食/昼食/夕食/間食）も自動判定する。時間情報がない場合は現在時刻から推測する。

**Why this priority**: 入力の手間をさらに削減し、より自然な操作感を実現する。P1の基盤があって初めて意味を持つ機能。

**Independent Test**: 「朝ごはんにトースト」と入力し、食事タイプが「朝食」として自動設定されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが食事を入力する状態, **When** 「昼に〇〇」と入力, **Then** 食事タイプが「昼食」に自動設定される
2. **Given** 時間情報なしで入力, **When** 午前7-10時に入力, **Then** 食事タイプが「朝食」に推測設定される
3. **Given** 自動判定された食事タイプ, **When** ユーザーが変更したい場合, **Then** 手動で上書き可能

---

### User Story 3 - 統合された入力体験 (Priority: P3)

現在分離している「AI食事分析」と「手動入力」を統合し、一つの入力フォームから写真アップロード、テキスト入力、AI相談のすべてが可能になる。

**Why this priority**: ユーザーの混乱を解消し、どの入力方法を選んでも一貫した体験を提供する。既存機能の再編成。

**Independent Test**: 同一の入力エリアから、テキスト入力とカメラアイコンでの写真入力の両方ができることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが食事ページにいる状態, **When** テキストを入力, **Then** AI分析が実行される
2. **Given** ユーザーが食事ページにいる状態, **When** 写真をアップロード, **Then** 同じ画面内でAI分析が実行される
3. **Given** AI分析結果が表示された状態, **When** AIとチャットで調整したい場合, **Then** 同じ画面内でチャットが開く

---

### Edge Cases

- AI分析が失敗した場合：エラーメッセージを表示し、手動入力にフォールバックできる
- 認識できない食品名の場合：「〇〇のカロリーがわかりません。推定値を入力するか、詳細を教えてください」と案内
- 複数の食品を一度に入力した場合：「ラーメンとチャーハン」→ 各食品を個別に認識して合計を表示
- ネットワークエラーの場合：オフライン時は手動入力のみ可能と案内
- AI応答タイムアウトの場合：10秒経過後にタイムアウトエラーを表示し、手動入力にフォールバック

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、食事ページでテキスト入力を受け付け、送信ボタンクリック時にAIによるカロリー・栄養素計算を実行しなければならない
- **FR-002**: システムは、AI計算中にローディング表示を行い、結果（カロリー、タンパク質、脂質、炭水化物）を表示しなければならない。10秒でタイムアウトとする
- **FR-003**: ユーザーは、AI計算結果を確認後、ワンクリックで食事記録として保存できなければならない
- **FR-004**: ユーザーは、AI計算結果のカロリー値を手動で修正できなければならない
- **FR-005**: システムは、入力テキストから食事タイプ（朝食/昼食/夕食/間食）を自動判定しなければならない
- **FR-006**: システムは、食事タイプの自動判定ができない場合、現在時刻から推測しなければならない
- **FR-007**: ユーザーは、自動判定された食事タイプを手動で変更できなければならない
- **FR-008**: システムは、同一の入力エリアからテキスト入力と写真アップロードの両方を受け付けなければならない
- **FR-009**: システムは、AI分析失敗時にユーザーフレンドリーなエラーメッセージを表示しなければならない
- **FR-010**: 既存の「AI食事分析」ページ（/meals/analyze）は完全に削除しなければならない

### Key Entities

- **食事入力**: ユーザーが入力したテキストまたは写真、AI分析結果、最終的な記録データを含む
- **AI分析結果**: カロリー、タンパク質、脂質、炭水化物、食品名、推定ポーション
- **食事タイプ判定**: 入力テキストからの抽出結果または時刻ベースの推測結果

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが食事を入力してから記録完了まで30秒以内に完了できる（現状の6ステップから2ステップに削減）
- **SC-002**: 食事タイプの自動判定精度が80%以上
- **SC-003**: AI分析の成功率が95%以上（既知の一般的な食品に対して）
- **SC-004**: 入力フロー完了率が現状比で50%向上（途中離脱の減少）
- **SC-005**: ユーザーが初回利用時に説明なしで食事記録を完了できる（直感的なUI）

## Clarifications

### Session 2026-01-01

- Q: AI計算のトリガータイミング → A: 送信ボタンクリック時に実行
- Q: 既存「AI食事分析」ページの移行方法 → A: 完全削除（未リリースのため互換性不要）
- Q: AI応答時間の期待値 → A: ローディング表示あり、10秒でタイムアウト

## Assumptions

- 既存のAI食事分析機能（gemini-3-flash-preview）は引き続き使用可能
- 既存のデータモデル（meal_records, meal_food_items等）は変更不要
- 食事タイプの時刻ベース推測ルール：
  - 6:00-10:00 → 朝食
  - 11:00-14:00 → 昼食
  - 17:00-21:00 → 夕食
  - その他 → 間食
- モバイルとデスクトップの両方で動作する必要がある
