# Feature Specification: 食事日時コントロール

**Feature Branch**: `011-meal-datetime`
**Created**: 2026-01-03
**Status**: Draft
**Input**: User description: "食事登録時、編集時に食事を行った日時を制御できない。食事入力は次の日等の場合もあるのでコントロールできるようにしたい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 過去の食事を登録する (Priority: P1)

ユーザーは、その日のうちに記録できなかった食事（例：昨日の夕食、今朝の朝食）を後から正確な日時で登録したい。

**Why this priority**: これは最も一般的なユースケース。忙しい日常の中で食事をリアルタイムで記録できないことは頻繁に起こる。正確な記録がないとダッシュボードの日別カロリー集計が不正確になる。

**Independent Test**: 食事登録画面で日時を任意に設定して登録し、食事一覧で指定した日時に正しく表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが食事登録画面を開いている, **When** 日付選択で「昨日」を選択し、時刻を「19:30」に設定して登録する, **Then** 食事は昨日の19:30として記録され、昨日の食事一覧に表示される
2. **Given** ユーザーが食事登録画面を開いている, **When** 日付を3日前に設定して登録する, **Then** 食事は3日前の日付で記録され、その日の食事一覧に表示される
3. **Given** ユーザーが食事登録画面を開いている, **When** 日時を指定せずに登録する, **Then** 現在日時が自動的に設定されて記録される

---

### User Story 2 - 既存の食事記録の日時を修正する (Priority: P2)

ユーザーは、間違った日時で記録してしまった食事を正しい日時に修正したい。

**Why this priority**: 登録時の入力ミスは起こりうる。誤った日時のままだとダッシュボードの集計に影響する。ただし、新規登録より頻度は低い。

**Independent Test**: 既存の食事記録の編集画面を開き、日時を変更して保存し、変更後の日時で正しく表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが食事詳細ページの編集モードを開いている, **When** 記録日時を別の日付・時刻に変更して保存する, **Then** 食事記録の日時が更新され、新しい日付の食事一覧に移動する
2. **Given** ユーザーが食事の記録日時を変更しようとしている, **When** 変更せずにキャンセルする, **Then** 元の日時のまま保持される

---

### User Story 3 - 日付をまたいで食事を管理する (Priority: P3)

ユーザーは、深夜の食事や日付をまたいだ食事を適切な日に記録したい（例：0:30の夜食を前日の夕食として記録）。

**Why this priority**: 深夜の食事をどの日にカウントするかはユーザーの好みによる。柔軟性があることで正確なカロリー管理ができる。

**Independent Test**: 深夜0:30の食事を前日の日付で登録し、前日の食事一覧とダッシュボードに反映されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 現在時刻が1月2日の0:30である, **When** ユーザーが日付を1月1日に変更して食事を登録する, **Then** 食事は1月1日の食事としてカウントされ、1月1日のダッシュボードに反映される

---

### Edge Cases

- ユーザーが未来の日時を設定しようとした場合はどうするか？ → 現在日時以前のみ許可（未来の食事は記録できない）
- 極端に古い日付（例：1年以上前）を設定した場合は？ → 許可するが、ユーザビリティのため過去30日程度を簡単に選べるUIを提供
- 日時変更後、元の日付のダッシュボード集計はどうなるか？ → 自動的に再集計される（既存のダッシュボード機能で対応済み）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、食事登録時に任意の日時（現在以前）を指定できるようにMUST
- **FR-002**: システムは、食事編集画面で記録日時を変更できるようにMUST
- **FR-003**: システムは、日時選択で日付と時刻を個別に設定できるUIをMUST提供する
- **FR-004**: システムは、デフォルトで現在日時を設定し、ユーザーが変更しない場合は現在日時で記録MUST
- **FR-005**: システムは、未来の日時を指定した場合にバリデーションエラーを表示MUST
- **FR-006**: システムは、日時変更後も食事記録に紐づく食材情報やチャット履歴を保持MUST
- **FR-007**: システムは、日時変更により食事が別の日に移動した場合、元の日と新しい日のダッシュボード集計を自動更新MUST

### Key Entities *(include if feature involves data)*

- **MealRecord**: 食事記録。`recordedAt` フィールドで記録日時を管理。ユーザーが指定した日時で保存される。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは食事登録時に30秒以内で任意の日時を設定できる
- **SC-002**: ユーザーは食事編集時に3タップ以内で日時変更画面にアクセスできる
- **SC-003**: 日時変更後、1秒以内に変更が反映され、正しい日付の一覧に表示される
- **SC-004**: 全ての日時変更操作において、関連データ（食材、チャット履歴）が100%保持される

## Assumptions

- モバイルブラウザの `datetime-local` 入力タイプを使用（ネイティブUIを活用）
- タイムゾーンはユーザーのブラウザのローカルタイムゾーンを使用（既存の実装を踏襲）
- 日時の最小単位は分（秒は不要）
- 食事タイプ（朝食、昼食、夕食、間食）と日時の整合性チェックは行わない（ユーザーの自由に任せる）
