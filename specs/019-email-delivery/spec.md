# Feature Specification: Email Delivery System

**Feature Branch**: `019-email-delivery`
**Created**: 2026-01-10
**Status**: Draft
**Input**: User description: "メール配信機能の追加（パスワードリセット、メールアドレス確認）"

## Clarifications

### Session 2026-01-10

- Q: トークンのセキュリティ要件（長さ、エントロピー）は？ → A: 32文字（256bit）、OWASP推奨レベル
- Q: メール送信失敗時のリトライ戦略は？ → A: 3回リトライ（指数バックオフ: 1s, 2s, 4s）
- Q: 管理者通知の配信方法は？ → A: notify.sh使用
- Q: メール送信サービス完全障害時のユーザー体験は？ → A: エラー表示＋手動リトライボタン提供
- Q: メール確認未完了ユーザーのアカウント保持期間は？ → A: 7日間で自動削除

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Password Reset Flow (Priority: P1)

既存ユーザーがパスワードを忘れた場合、メールでリセットリンクを受け取り、新しいパスワードを設定できる。

**Why this priority**: セキュリティ上の必須機能。ユーザーがアカウントにアクセスできなくなるのを防ぐ最重要機能。

**Independent Test**: ログイン画面で「パスワードを忘れた」をクリックし、メールアドレスを入力。受信したメールのリンクから新しいパスワードを設定し、新パスワードでログインできることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーがログイン画面にいる, **When** 「パスワードを忘れた」リンクをクリックして登録済みメールアドレスを入力, **Then** パスワードリセット用の一時的なトークン付きリンクがメールで送信される
2. **Given** ユーザーがリセットメールを受信した, **When** メール内のリンクをクリック, **Then** 新しいパスワード入力画面が表示され、トークンの有効性が確認される
3. **Given** ユーザーがパスワードリセット画面にいる, **When** 新しいパスワードを2回入力して送信, **Then** パスワードが更新され、ログイン画面にリダイレクトされる
4. **Given** ユーザーが新しいパスワードを設定した, **When** 新しいパスワードでログインを試行, **Then** 正常にログインできる
5. **Given** パスワードリセットリンクが24時間以上経過している, **When** リンクをクリック, **Then** 「リンクの有効期限が切れています」というエラーメッセージが表示される

---

### User Story 2 - Email Verification on Signup (Priority: P2)

新規ユーザー登録時に、入力したメールアドレスが本人のものであることを確認する。

**Why this priority**: ユーザー登録の信頼性を確保し、不正登録やタイポによるトラブルを防ぐ。

**Independent Test**: 新規登録フォームでメールアドレスとパスワードを入力。受信した確認メールのリンクをクリックし、アカウントが有効化されることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが新規登録フォームにいる, **When** メールアドレスとパスワードを入力して送信, **Then** アカウントが仮登録状態で作成され、確認メールが送信される
2. **Given** ユーザーが確認メールを受信した, **When** メール内の確認リンクをクリック, **Then** アカウントが有効化され、「メールアドレスが確認されました」というメッセージが表示される
3. **Given** ユーザーがメール確認前にログインを試行した, **When** 正しいメールアドレスとパスワードでログイン, **Then** 「メールアドレスを確認してください」という警告が表示され、ログインできない
4. **Given** 確認リンクが48時間以上経過している, **When** リンクをクリック, **Then** 「リンクの有効期限が切れています。再送してください」というメッセージが表示される
5. **Given** ユーザーが確認メールを受信していない, **When** 「確認メールを再送」ボタンをクリック, **Then** 新しい確認メールが送信される

---

### User Story 3 - Email Change Verification (Priority: P3)

既存ユーザーがメールアドレスを変更する際、新しいメールアドレスの所有権を確認する。

**Why this priority**: 既存ユーザー向けの追加機能。セキュリティは重要だが、利用頻度は低い。

**Independent Test**: 設定画面で新しいメールアドレスを入力。新旧両方のメールアドレスに確認メールが送信され、新メールアドレスのリンクをクリックすると変更が完了することを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーがアカウント設定画面にいる, **When** 新しいメールアドレスを入力して「変更」をクリック, **Then** 現在のメールアドレスと新しいメールアドレスの両方に確認メールが送信される
2. **Given** ユーザーが新しいメールアドレスで確認メールを受信した, **When** メール内の確認リンクをクリック, **Then** メールアドレスが更新され、「メールアドレスが変更されました」というメッセージが表示される
3. **Given** メールアドレス変更の確認待ち状態である, **When** 古いメールアドレスでログイン, **Then** 「メールアドレス変更の確認待ちです」という通知が表示される
4. **Given** ユーザーが誤って変更を開始した, **When** 旧メールアドレスに送信されたメール内の「キャンセル」リンクをクリック, **Then** メールアドレス変更がキャンセルされる
5. **Given** 確認リンクが24時間以上経過している, **When** リンクをクリック, **Then** 「リンクの有効期限が切れています」というエラーメッセージが表示される

---

### Edge Cases

- **トークンの有効期限**: リセット/確認リンクが期限切れの場合、明確なエラーメッセージと再送オプションを提供する
- **メール送信失敗**: メール配信サービスがエラーを返した場合、ユーザーにエラーメッセージを表示し、手動リトライボタンを提供する（ユーザーが自分で再送信を実行可能）
- **存在しないメールアドレスへのパスワードリセット**: セキュリティのため、「メールを送信しました」と表示（メールアドレスの存在を漏らさない）
- **重複メールアドレス**: 新規登録時に既存のメールアドレスが入力された場合、「このメールアドレスは既に登録されています」とエラー表示
- **スパム対策**: 同一IPアドレスから短時間に大量のメール送信リクエストがあった場合、レート制限を適用
- **トークンの再利用**: 使用済みのリセット/確認トークンは無効化し、再利用できないようにする
- **未確認アカウントの自動削除**: メールアドレス確認が完了していないアカウントは登録後7日間で自動削除される。削除前に通知は送信しない（スパム対策）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、パスワードリセット用のユニークで推測不可能なトークン（32文字、256bitエントロピー）を生成しなければならない
- **FR-002**: システムは、パスワードリセットトークンの有効期限を24時間に設定しなければならない
- **FR-003**: システムは、メールアドレス確認用のトークン（32文字、256bitエントロピー）を生成し、有効期限を48時間に設定しなければならない
- **FR-004**: システムは、メールアドレス変更確認用のトークン（32文字、256bitエントロピー）を生成し、有効期限を24時間に設定しなければならない
- **FR-005**: システムは、トークンを使用後に無効化し、再利用を防止しなければならない
- **FR-006**: システムは、視覚的に整形されたブランド化されたメールを送信しなければならない
- **FR-007**: システムは、メール送信時にユーザーの優先言語（日本語/英語）に応じてテンプレートを選択しなければならない
- **FR-008**: システムは、メール送信失敗時に最大3回まで指数バックオフ（1秒、2秒、4秒）でリトライしなければならない
- **FR-008a**: システムは、3回のリトライ後も失敗した場合、エラーログを記録し、システム通知機構（notify.sh）を使用して管理者に通知しなければならない
- **FR-008b**: システムは、メール送信失敗時にユーザーに明確なエラーメッセージと手動リトライボタンを表示しなければならない
- **FR-009**: システムは、同一IPアドレスから1時間あたり最大10回のメール送信リクエストに制限しなければならない
- **FR-010**: システムは、パスワードリセット時に新しいパスワードが最低8文字、大文字、小文字、数字を含むことを検証しなければならない
- **FR-011**: システムは、メールアドレス変更時に新しいメールアドレスが有効な形式であることを検証しなければならない
- **FR-012**: システムは、メールアドレス確認が完了していないユーザーのログインを拒否しなければならない
- **FR-012a**: システムは、メールアドレス確認が完了していないアカウントを登録後7日間で自動削除しなければならない
- **FR-013**: システムは、確認メールの再送機能を提供しなければならない（最大3回/日）
- **FR-014**: システムは、メールアドレス変更時に旧アドレスと新アドレスの両方に通知を送信しなければならない

### Key Entities

- **Password Reset Token**: パスワードリセット要求を識別するトークン。ユーザーID、トークン文字列、有効期限、使用済みフラグを含む
- **Email Verification Token**: メールアドレス確認を識別するトークン。ユーザーID、メールアドレス、トークン文字列、有効期限、使用済みフラグを含む
- **Email Change Request**: メールアドレス変更要求。ユーザーID、旧メールアドレス、新メールアドレス、トークン文字列、有効期限、ステータス（保留中/完了/キャンセル）を含む
- **Email Delivery Log**: メール送信履歴。送信日時、受信者、メールタイプ、ステータス（成功/失敗）、エラーメッセージを含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは、パスワードリセット要求から新しいパスワードでのログインまでを5分以内に完了できる
- **SC-002**: メール送信成功率が99%以上である（メールサービス側の障害を除く）
- **SC-003**: メール配信遅延が90%のケースで30秒以内である
- **SC-004**: パスワードリセット機能により、パスワード関連のサポート問い合わせが80%削減される
- **SC-005**: 新規登録ユーザーの95%が24時間以内にメールアドレスを確認する
- **SC-006**: メールアドレス確認未完了ユーザーによる不正ログイン試行が0件である
- **SC-007**: スパム対策により、悪意のあるメール送信リクエストが99%ブロックされる

## Assumptions

- ユーザーのメールアドレスは既にデータベースに保存されている（既存の認証システムが存在）
- メール配信サービスのAPIキーとドメイン設定は既に完了している
- ユーザーはメール受信可能な環境にあり、スパムフィルターに振り分けられない前提
- メールテンプレートのデザインは既存のブランドガイドラインに準拠する
- システムは日本語と英語の2言語をサポートする（ユーザーの言語設定に基づく）

## Out of Scope

- 2要素認証（2FA）機能（将来の機能として検討）
- SMS/電話番号によるパスワードリセット（メールのみ対応）
- ソーシャルログイン（Google, Facebook等）との統合
- メール配信の詳細な分析（開封率、クリック率等）
- メールテンプレートのビジュアルエディター機能
- メール配信のスケジュール機能（即時送信のみ）
- メール配信のA/Bテスト機能
