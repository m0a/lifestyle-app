import{r as l,j as e,u as U,m as k,a as $}from"./index-C09T-Kt9.js";function O({onCapture:r,onCancel:p,maxSize:a=1024}){const[d,m]=l.useState("select"),[u,f]=l.useState(!1),[j,x]=l.useState(null),v=l.useRef(null),y=l.useRef(null),h=l.useRef(null),N=l.useCallback(async(s,t)=>new Promise((o,i)=>{const b=URL.createObjectURL(s),c=new Image,g=()=>{URL.revokeObjectURL(b)};c.onload=()=>{try{const F=Math.min(1,t/Math.max(c.width,c.height)),P=Math.round(c.width*F),R=Math.round(c.height*F);let I,M;if(typeof OffscreenCanvas<"u"?(I=new OffscreenCanvas(P,R),M=I.getContext("2d")):(I=document.createElement("canvas"),I.width=P,I.height=R,M=I.getContext("2d")),!M){g(),i(new Error("Canvas context not available"));return}M.drawImage(c,0,0,P,R),I instanceof OffscreenCanvas?I.convertToBlob({type:"image/jpeg",quality:.8}).then(E=>{g(),o(E)}).catch(E=>{g(),i(E)}):I.toBlob(E=>{g(),E?o(E):i(new Error("Failed to create blob"))},"image/jpeg",.8)}catch(F){g(),i(F)}},c.onerror=()=>{g(),i(new Error("Failed to load image"))},c.src=b}),[]),C=l.useCallback(async s=>{var o;const t=(o=s.target.files)==null?void 0:o[0];if(t){if(!t.type.startsWith("image/")){x("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");return}f(!0),x(null);try{const i=await N(t,a);r(i)}catch(i){x("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ"),console.error(i)}finally{f(!1)}}},[a,r,N]),S=l.useCallback(async()=>{x(null);try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});y.current=s,v.current&&(v.current.srcObject=s),m("camera")}catch(s){x("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"),console.error(s)}},[]),w=l.useCallback(()=>{y.current&&(y.current.getTracks().forEach(s=>s.stop()),y.current=null),m("select")},[]),n=l.useCallback(async()=>{if(v.current){f(!0),x(null);try{const s=v.current,t=document.createElement("canvas");t.width=s.videoWidth,t.height=s.videoHeight;const o=t.getContext("2d");if(!o)throw new Error("Canvas context not available");o.drawImage(s,0,0);const i=await new Promise((c,g)=>{t.toBlob(F=>F?c(F):g(new Error("Failed to create blob")),"image/jpeg",.9)}),b=await N(i,a);w(),r(b)}catch(s){x("æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸ"),console.error(s)}finally{f(!1)}}},[a,r,N,w]);return d==="camera"?e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("video",{ref:v,autoPlay:!0,playsInline:!0,className:"w-full max-w-md rounded-lg border"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:n,disabled:u,className:"rounded-full bg-blue-500 p-4 text-white hover:bg-blue-600 disabled:opacity-50",children:u?"å‡¦ç†ä¸­...":"æ’®å½±"}),e.jsx("button",{onClick:w,className:"rounded-lg border px-4 py-2 hover:bg-gray-100",children:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"})]}),j&&e.jsx("p",{className:"text-sm text-red-500",children:j})]}):e.jsxs("div",{className:"flex flex-col items-center gap-4 p-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"é£Ÿäº‹ã®å†™çœŸã‚’è¿½åŠ "}),e.jsx("input",{ref:h,type:"file",accept:"image/*",onChange:C,className:"hidden"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("button",{onClick:()=>{var s;return(s=h.current)==null?void 0:s.click()},disabled:u,className:"flex items-center gap-2 rounded-lg border px-4 py-3 hover:bg-gray-100 disabled:opacity-50",children:[e.jsx("span",{children:"ğŸ“"}),e.jsx("span",{children:"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ"})]}),e.jsxs("button",{onClick:S,disabled:u,className:"flex items-center gap-2 rounded-lg border px-4 py-3 hover:bg-gray-100 disabled:opacity-50",children:[e.jsx("span",{children:"ğŸ“·"}),e.jsx("span",{children:"ã‚«ãƒ¡ãƒ©ã§æ’®å½±"})]})]}),u&&e.jsx("p",{className:"text-sm text-gray-500",children:"ç”»åƒã‚’å‡¦ç†ä¸­..."}),j&&e.jsx("p",{className:"text-sm text-red-500",children:j}),p&&e.jsx("button",{onClick:p,className:"text-sm text-gray-500 hover:text-gray-700",children:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"})]})}function T({photoUrl:r,foodItems:p,totals:a,isLoading:d,onUpdateItem:m,onDeleteItem:u,onAddItem:f}){const[j,x]=l.useState(null),[v,y]=l.useState(!1);return d?e.jsxs("div",{className:"flex flex-col items-center gap-4 p-8",children:[e.jsx("div",{className:"h-12 w-12 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"}),e.jsx("p",{className:"text-gray-600",children:"AI ãŒé£Ÿäº‹ã‚’åˆ†æä¸­..."})]}):e.jsxs("div",{className:"flex flex-col gap-4",children:[r&&e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:r,alt:"é£Ÿäº‹ã®å†™çœŸ",className:"max-h-48 rounded-lg object-cover"})}),e.jsxs("div",{className:"rounded-lg bg-blue-50 p-4",children:[e.jsx("h3",{className:"mb-2 font-semibold",children:"åˆè¨ˆ"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2 text-center text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:a.calories}),e.jsx("div",{className:"text-gray-500",children:"kcal"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-green-600",children:a.protein.toFixed(1)}),e.jsx("div",{className:"text-gray-500",children:"P (g)"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-yellow-600",children:a.fat.toFixed(1)}),e.jsx("div",{className:"text-gray-500",children:"F (g)"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-orange-600",children:a.carbs.toFixed(1)}),e.jsx("div",{className:"text-gray-500",children:"C (g)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold",children:"è­˜åˆ¥ã•ã‚ŒãŸé£Ÿæ"}),p.map(h=>j===h.id?e.jsx(L,{item:h,onSave:async N=>{await(m==null?void 0:m(h.id,N)),x(null)},onCancel:()=>x(null)},h.id):e.jsx(D,{item:h,onEdit:()=>x(h.id),onDelete:()=>u==null?void 0:u(h.id),editable:!!m},h.id))]}),f&&e.jsx("div",{children:v?e.jsx(L,{onSave:async h=>{await f(h),y(!1)},onCancel:()=>y(!1)}):e.jsx("button",{onClick:()=>y(!0),className:"w-full rounded-lg border-2 border-dashed border-gray-300 py-3 text-gray-500 hover:border-gray-400 hover:text-gray-600",children:"+ é£Ÿæã‚’è¿½åŠ "})})]})}function D({item:r,onEdit:p,onDelete:a,editable:d}){const m={small:"å°",medium:"ä¸­",large:"å¤§"}[r.portion];return e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:r.name}),e.jsx("span",{className:"rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-600",children:m})]}),e.jsxs("div",{className:"mt-1 text-sm text-gray-500",children:[r.calories,"kcal | P",r.protein,"g F",r.fat,"g C",r.carbs,"g"]})]}),d&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:p,className:"rounded p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-600",children:"âœï¸"}),e.jsx("button",{onClick:a,className:"rounded p-1 text-gray-400 hover:bg-gray-100 hover:text-red-500",children:"ğŸ—‘ï¸"})]})]})}function L({item:r,onSave:p,onCancel:a}){var t,o,i,b;const[d,m]=l.useState((r==null?void 0:r.name)||""),[u,f]=l.useState((r==null?void 0:r.portion)||"medium"),[j,x]=l.useState(((t=r==null?void 0:r.calories)==null?void 0:t.toString())||""),[v,y]=l.useState(((o=r==null?void 0:r.protein)==null?void 0:o.toString())||""),[h,N]=l.useState(((i=r==null?void 0:r.fat)==null?void 0:i.toString())||""),[C,S]=l.useState(((b=r==null?void 0:r.carbs)==null?void 0:b.toString())||""),[w,n]=l.useState(!1),s=async c=>{c.preventDefault(),n(!0);try{await p({name:d,portion:u,calories:parseInt(j)||0,protein:parseFloat(v)||0,fat:parseFloat(h)||0,carbs:parseFloat(C)||0})}finally{n(!1)}};return e.jsxs("form",{onSubmit:s,className:"space-y-3 rounded-lg border p-3",children:[e.jsx("div",{children:e.jsx("input",{type:"text",value:d,onChange:c=>m(c.target.value),placeholder:"é£Ÿæå",required:!0,className:"w-full rounded border px-3 py-2"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:u,onChange:c=>f(c.target.value),className:"rounded border px-3 py-2",children:[e.jsx("option",{value:"small",children:"å°"}),e.jsx("option",{value:"medium",children:"ä¸­"}),e.jsx("option",{value:"large",children:"å¤§"})]}),e.jsx("input",{type:"number",value:j,onChange:c=>x(c.target.value),placeholder:"kcal",required:!0,className:"w-20 rounded border px-3 py-2"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.1",value:v,onChange:c=>y(c.target.value),placeholder:"P (g)",className:"w-20 rounded border px-3 py-2"}),e.jsx("input",{type:"number",step:"0.1",value:h,onChange:c=>N(c.target.value),placeholder:"F (g)",className:"w-20 rounded border px-3 py-2"}),e.jsx("input",{type:"number",step:"0.1",value:C,onChange:c=>S(c.target.value),placeholder:"C (g)",className:"w-20 rounded border px-3 py-2"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:a,className:"rounded px-3 py-1 text-gray-500 hover:bg-gray-100",children:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"}),e.jsx("button",{type:"submit",disabled:w,className:"rounded bg-blue-500 px-3 py-1 text-white hover:bg-blue-600 disabled:opacity-50",children:w?"ä¿å­˜ä¸­...":"ä¿å­˜"})]})]})}function H({mealId:r,currentFoodItems:p,onUpdate:a}){const d=U(),[m,u]=l.useState([]),[f,j]=l.useState(""),[x,v]=l.useState(!1),[y,h]=l.useState([]),N=l.useRef(null);l.useEffect(()=>{(async()=>{try{const{messages:s}=await k.getChatHistory(r);u(s.map(t=>({id:t.id,role:t.role,content:t.content,changes:t.appliedChanges})))}catch(s){console.error("Failed to load chat history:",s),s instanceof TypeError&&s.message==="Failed to fetch"&&d.warning("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")}})()},[r,d]),l.useEffect(()=>{var n;(n=N.current)==null||n.scrollIntoView({behavior:"smooth"})},[m]);const C=l.useCallback(async()=>{if(!f.trim()||x)return;const n=f.trim();j(""),v(!0);const s=`user-${Date.now()}`;u(o=>[...o,{id:s,role:"user",content:n}]);const t=`assistant-${Date.now()}`;u(o=>[...o,{id:t,role:"assistant",content:"",isStreaming:!0}]);try{let o="",i=[];for await(const b of k.sendChatMessage(r,n))b.text&&(o+=b.text,u(c=>c.map(g=>g.id===t?{...g,content:o}:g))),b.done&&(i=b.changes||[],u(c=>c.map(g=>g.id===t?{...g,id:b.messageId||t,isStreaming:!1,changes:i}:g)),i.length>0&&h(i)),b.error&&u(c=>c.map(g=>g.id===t?{...g,content:b.error||"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",isStreaming:!1}:g))}catch(o){console.error("Chat error:",o),u(i=>i.map(b=>b.id===t?{...b,content:"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",isStreaming:!1}:b))}finally{v(!1)}},[f,x,r]),S=l.useCallback(async()=>{if(y.length!==0)try{const n=await k.applyChatSuggestion(r,y);a(n.foodItems,n.updatedTotals),h([]),d.success("å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã—ãŸ")}catch(n){console.error("Apply changes error:",n),n instanceof TypeError&&n.message==="Failed to fetch"?d.error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã§ãã¾ã›ã‚“"):d.error("å¤‰æ›´ã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ")}},[r,y,a,d]),w=l.useCallback(n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),C())},[C]);return e.jsxs("div",{className:"rounded-lg border",children:[e.jsxs("div",{className:"h-64 overflow-y-auto p-4",children:[m.length===0&&e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx("p",{children:"AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã«è³ªå•ã—ã¦ãã ã•ã„"}),e.jsx("p",{className:"mt-2 text-sm",children:"ä¾‹: ã”é£¯ã‚’åŠåˆ†ã«ã—ãŸã„ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’å¢—ã‚„ã™ã«ã¯ï¼Ÿ"})]}),m.map(n=>e.jsx("div",{className:`mb-3 ${n.role==="user"?"text-right":"text-left"}`,children:e.jsxs("div",{className:`inline-block max-w-[80%] rounded-lg px-4 py-2 ${n.role==="user"?"bg-blue-500 text-white":"bg-gray-100 text-gray-800"}`,children:[n.content,n.isStreaming&&e.jsx("span",{className:"ml-1 animate-pulse",children:"..."})]})},n.id)),e.jsx("div",{ref:N})]}),y.length>0&&e.jsxs("div",{className:"border-t bg-yellow-50 p-3",children:[e.jsx("p",{className:"mb-2 text-sm font-medium",children:"AIã‹ã‚‰ã®å¤‰æ›´ææ¡ˆ:"}),e.jsx("ul",{className:"mb-2 text-sm text-gray-600",children:y.map((n,s)=>{var t;return e.jsxs("li",{children:[n.action==="add"&&`è¿½åŠ : ${(t=n.foodItem)==null?void 0:t.name}`,n.action==="remove"&&"å‰Šé™¤: (é£Ÿæ)",n.action==="update"&&"å¤‰æ›´: (é£Ÿæ)"]},s)})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:S,className:"rounded bg-green-500 px-4 py-1 text-sm text-white hover:bg-green-600",children:"é©ç”¨ã™ã‚‹"}),e.jsx("button",{onClick:()=>h([]),className:"rounded px-4 py-1 text-sm text-gray-500 hover:bg-gray-200",children:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"})]})]}),e.jsxs("div",{className:"flex border-t p-3",children:[e.jsx("input",{type:"text",value:f,onChange:n=>j(n.target.value),onKeyPress:w,placeholder:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...",disabled:x,className:"flex-1 rounded-l-lg border-y border-l px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{onClick:C,disabled:x||!f.trim(),className:"rounded-r-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600 disabled:opacity-50",children:"é€ä¿¡"})]})]})}function A(r){return r instanceof TypeError&&r.message==="Failed to fetch"?"ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚":r instanceof Error?r.message:"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}function q(){const r=$(),p=U(),[a,d]=l.useState({phase:"capture"}),[m,u]=l.useState(!1),[f,j]=l.useState("lunch"),[x,v]=l.useState(!1),y=l.useCallback(async s=>{d({phase:"analyzing"});try{const t=await k.analyzeMealPhoto(s);if("error"in t){d({phase:"error",message:t.message});return}const o=t;d({phase:"result",mealId:o.mealId,photoUrl:`/api/photos/${encodeURIComponent(o.photoKey)}`,foodItems:o.foodItems,totals:o.totals})}catch(t){console.error("Analysis error:",t),d({phase:"error",message:t instanceof Error?t.message:"åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"})}},[]),h=l.useCallback(async(s,t)=>{if(a.phase==="result")try{const o=await k.updateFoodItem(a.mealId,s,t);d({...a,foodItems:a.foodItems.map(i=>i.id===s?o.foodItem:i),totals:o.updatedTotals})}catch(o){console.error("Update item error:",o),p.error(A(o))}},[a,p]),N=l.useCallback(async s=>{if(a.phase==="result")try{const t=await k.deleteFoodItem(a.mealId,s);d({...a,foodItems:a.foodItems.filter(o=>o.id!==s),totals:t.updatedTotals})}catch(t){console.error("Delete item error:",t),p.error(A(t))}},[a,p]),C=l.useCallback(async s=>{if(a.phase==="result")try{const t=await k.addFoodItem(a.mealId,s);d({...a,foodItems:[...a.foodItems,t.foodItem],totals:t.updatedTotals})}catch(t){console.error("Add item error:",t),p.error(A(t))}},[a,p]),S=l.useCallback((s,t)=>{a.phase==="result"&&d({...a,foodItems:s,totals:t})},[a]),w=l.useCallback(async()=>{if(a.phase==="result"){v(!0);try{await k.saveMealAnalysis(a.mealId,f),p.success("é£Ÿäº‹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ"),r("/meal")}catch(s){console.error("Save error:",s),p.error(A(s))}finally{v(!1)}}},[a,f,r,p]),n=l.useCallback(()=>{d({phase:"capture"}),u(!1)},[]);return e.jsxs("div",{className:"mx-auto max-w-lg p-4",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl font-bold",children:"AIé£Ÿäº‹åˆ†æ"}),a.phase==="result"&&e.jsx("button",{onClick:n,className:"text-sm text-gray-500 hover:text-gray-700",children:"ã‚„ã‚Šç›´ã™"})]}),a.phase==="capture"&&e.jsx(O,{onCapture:y,onCancel:()=>r(-1)}),a.phase==="analyzing"&&e.jsx(T,{foodItems:[],totals:{calories:0,protein:0,fat:0,carbs:0},isLoading:!0}),a.phase==="error"&&e.jsxs("div",{className:"flex flex-col items-center gap-4 rounded-lg bg-red-50 p-6",children:[e.jsx("p",{className:"text-red-600",children:a.message}),e.jsx("button",{onClick:n,className:"rounded bg-red-500 px-4 py-2 text-white hover:bg-red-600",children:"ã‚‚ã†ä¸€åº¦æ’®å½±ã™ã‚‹"})]}),a.phase==="result"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{photoUrl:a.photoUrl,foodItems:a.foodItems,totals:a.totals,onUpdateItem:h,onDeleteItem:N,onAddItem:C}),e.jsx("button",{onClick:()=>u(!m),className:"w-full rounded-lg border py-3 text-center hover:bg-gray-50",children:m?"ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’é–‰ã˜ã‚‹":"ğŸ’¬ AIã¨ç›¸è«‡ã—ã¦èª¿æ•´"}),m&&e.jsx(H,{mealId:a.mealId,currentFoodItems:a.foodItems,onUpdate:S}),e.jsxs("div",{className:"rounded-lg bg-gray-50 p-4",children:[e.jsx("h3",{className:"mb-3 font-semibold",children:"è¨˜éŒ²ã¨ã—ã¦ä¿å­˜"}),e.jsx("div",{className:"mb-4 flex gap-2",children:["breakfast","lunch","dinner","snack"].map(s=>e.jsxs("button",{onClick:()=>j(s),className:`flex-1 rounded-lg py-2 text-sm ${f===s?"bg-blue-500 text-white":"bg-white border hover:bg-gray-100"}`,children:[s==="breakfast"&&"æœé£Ÿ",s==="lunch"&&"æ˜¼é£Ÿ",s==="dinner"&&"å¤•é£Ÿ",s==="snack"&&"é–“é£Ÿ"]},s))}),e.jsx("button",{onClick:w,disabled:x||a.foodItems.length===0,className:"w-full rounded-lg bg-blue-500 py-3 font-semibold text-white hover:bg-blue-600 disabled:opacity-50",children:x?"ä¿å­˜ä¸­...":"é£Ÿäº‹ã‚’è¨˜éŒ²ã™ã‚‹"})]})]})]})}export{q as default};
//# sourceMappingURL=MealAnalysis-C19wM5xY.js.map
